// server/src/services/keywordExtractor.js
import natural from "natural";
import sw from "stopword";

// (необов'язково) список українських стоп-слів (короткий приклад — доповни великим списком)
const ukrStopwords = [
  "і", "в", "не", "на", "та", "що", "з", "до", "у", "по", "за", "як", "то", 
  "це", "для", "при", "від", "із", "до", "або", "б", "же", "ж", "би", "бі", 
  "й", "а", "но", "про", "під", "над", "перед", "через", "без", "зо", "зі",
  "от", "ось", "ос", "ну", "хіба", "неначе", "наче", "якби", "коли", "де",
  "куди", "звідки", "чому", "навіщо", "який", "яка", "яке", "які", "чий",
  "чия", "чиє", "чиї", "скільки", "котрий", "хто", "що", "як", "чого",
  "кому", "ким", "цього", "тому", "цим", "усі", "всі", "ввесь", "увесь",
  "кожен", "будь", "хоч", "якийсь", "деякий", "жоден", "ніякий", "інший",
  "самий", "весь", "цей", "той", "такий", "стільки", "тут", "там", "тоді",
  "зараз", "вже", "ще", "тільки", "лише", "майже", "цілком", "зовсім",
  "дуже", "краще", "гірше", "більше", "менше", "добре", "погано", "можна",
  "треба", "може", "мусить", "повинен", "коли", "де", "як", "чому", "хіба",
  "ні", "так", "ось", "ну", "от", "же", "бо", "то", "це", "цей", "ця", "це",
  "ці", "той", "та", "те", "ті", "свій", "своя", "своє", "свої", "його",
  "її", "їх", "нам", "вам", "їм", "мені", "тобі", "йому", "їй", "нас",
  "вас", "їх", "мій", "твій", "наш", "ваш", "їхній", "хтось", "щось",
  "десь", "кудись", "хоч", "якось", "десь", "ніхто", "ніщо", "ніде",
  "нікуди", "ніяк", "ніде", "сьомий", "восьмий", "девятий", "десятий",
  "перший", "другий", "третій", "четвертий", "пятий", "шостий", "багато",
  "мало", "трохи", "кілька", "декілька", "стільки", "скільки", "стільки",
  "усюди", "ніде", "завжди", "ніколи", "іноді", "часто", "рідко", "швидко",
  "повільно", "рано", "пізно", "далеко", "близько", "високо", "низько",
  "глибоко", "поверх"
];

// Альтернативна версія з n-gram для кращих результатів
export function extractKeywords(text = "", topN = 20) {
  if (!text || typeof text !== "string") return [];

  // 1) Нормалізація
  const lower = text.toLowerCase();
  
  // 2) Токенізація та очищення
  const tokenizer = new natural.WordTokenizer();
  let tokens = tokenizer.tokenize(lower)
    .map(t => t.replace(/[^0-9a-zа-яіїєґ\-]/gi, ""))
    .filter(Boolean)
    .filter(t => t.length > 3);

  // 3) Стоп-слова
  const combinedStopwords = [...new Set([...sw.en, ...ukrStopwords])];
  tokens = sw.removeStopwords(tokens, combinedStopwords);

  // 4) Створюємо біграми (словосполучення з 2 слів)
  const bigrams = [];
  for (let i = 0; i < tokens.length - 1; i++) {
    bigrams.push(tokens[i] + ' ' + tokens[i + 1]);
  }

  // 5) Комбінуємо окремі слова та біграми
  const allTerms = [...tokens, ...bigrams];
  
  // 6) Частотний аналіз
  const freq = {};
  allTerms.forEach(term => {
    const weight = term.includes(' ') ? 3 : 1; // біграми мають більшу вагу
    freq[term] = (freq[term] || 0) + weight;
  });

  // 7) Сортування та відбір
  const result = Object.entries(freq)
    .sort((a, b) => b[1] - a[1])
    .slice(0, topN)
    .map(a => a[0]);

  return result;
}