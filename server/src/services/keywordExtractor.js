// server/src/services/keywordExtractor.js
import natural from "natural";
import sw from "stopword";

/// server/src/services/keywordExtractor.js

// Розширений список українських стоп-слів
const ukrStopwords = [
  "і", "в", "не", "на", "та", "що", "з", "до", "у", "по", "за", "як", "то", 
  "це", "для", "при", "від", "із", "до", "або", "б", "же", "ж", "би", "бі", 
  "й", "а", "но", "про", "під", "над", "перед", "через", "без", "зо", "зі",
  "от", "ось", "ос", "ну", "хіба", "неначе", "наче", "якби", "коли", "де",
  "куди", "звідки", "чому", "навіщо", "який", "яка", "яке", "які", "чий",
  "чия", "чиє", "чиї", "скільки", "котрий", "хто", "що", "як", "чого",
  "кому", "ким", "цього", "тому", "цим", "усі", "всі", "ввесь", "увесь",
  "кожен", "будь", "хоч", "якийсь", "деякий", "жоден", "ніякий", "інший",
  "самий", "весь", "цей", "той", "такий", "стільки", "тут", "там", "тоді",
  "зараз", "вже", "ще", "тільки", "лише", "майже", "цілком", "зовсім",
  "дуже", "краще", "гірше", "більше", "менше", "добре", "погано", "можна",
  "треба", "може", "мусить", "повинен", "ні", "так", "ось", "ну", "от", 
  "же", "бо", "то", "це", "цей", "ця", "це", "ці", "той", "та", "те", "ті",
  "свій", "своя", "своє", "свої", "його", "її", "їх", "нам", "вам", "їм",
  "мені", "тобі", "йому", "їй", "нас", "вас", "їх", "мій", "твій", "наш",
  "ваш", "їхній", "хтось", "щось", "десь", "кудись", "ніхто", "ніщо",
  "ніде", "нікуди", "ніяк", "перший", "другий", "третій", "багато", "мало",
  "трохи", "кілька", "декілька", "стільки", "скільки", "усюди", "ніде",
  "завжди", "ніколи", "іноді", "часто", "рідко", "швидко", "повільно",
  "рано", "пізно", "далеко", "близько", "високо", "низько", "глибоко",
  "геть", "зовсім", "майже", "приблизно", "рівно", "точно", "десь", "куди",
  "звідки", "чомусь", "якось", "десь", "іноді", "часто", "завжди", "ніколи",
  "потім", "тоді", "тепер", "зараз", "сьогодні", "вчора", "завтра", "рано",
  "пізно", "швидко", "повільно", "багато", "мало", "трохи", "зовсім", "цілком",
  "майже", "приблизно", "рівно", "точно", "десь", "куди", "звідки", "чомусь"
];

export function extractKeywords(text = "", topN = 20) {
  if (!text || typeof text !== "string") return [];

  console.log("Початковий текст (перші 500 символів):", text.substring(0, 500));

  // 1) нормалізація: нижній регістр
  const lower = text.toLowerCase();

  // 2) проста токенізація на слова
  let tokens = lower
    .split(/[\s\.,!?;:()«»""''–—]+/) // розділювачі
    .map(token => token.trim())
    .filter(token => token.length > 0);

  console.log("Токени після розділення:", tokens.length);

  // 3) очистка токенів від знаків пунктуації
  tokens = tokens
    .map(token => token.replace(/[^а-яіїєґ0-9\-]/gi, "")) // залишаємо лише українські букви, цифри та дефіс
    .filter(token => token.length >= 4) // мінімум 4 символи
    .filter(token => !token.match(/^\d+$/)) // видаляємо чисті числа
    .filter(token => !token.match(/^[а-яіїєґ]{1,3}$/)); // видаляємо дуже короткі слова

  console.log("Токени після очищення:", tokens.length);

  // 4) видаляємо стоп-слова
  const stopwordsSet = new Set(ukrStopwords);
  tokens = tokens.filter(token => !stopwordsSet.has(token));

  console.log("Токени після стоп-слів:", tokens.length);

  // 5) частотний аналіз з вагами
  const freq = {};
  tokens.forEach(token => {
    // Ваги за довжиною слова
    let weight = 1;
    if (token.length > 8) weight = 3;      // довгі слова - важливіші
    else if (token.length > 6) weight = 2; // середні слова
    else if (token.length === 4) weight = 0.5; // короткі слова менш важливі
    
    freq[token] = (freq[token] || 0) + weight;
  });

  // 6) Сортуємо за частотою та фільтруємо
  const sorted = Object.entries(freq)
    .sort((a, b) => {
      // Спершу за частотою, потім за довжиною слова
      if (b[1] !== a[1]) return b[1] - a[1];
      return b[0].length - a[0].length;
    })
    .slice(0, topN * 3) // беремо більше для подальшого фільтрування
    .map(a => a[0]);

  console.log("Топ слова за частотою:", sorted.slice(0, 15));

  // 7) Фільтруємо слова з небажаними суфіксами
  const badSuffixes = [
    'ться', 'ись', 'аться', 'иться', 'ються', 'ється', 
    'ання', 'ення', 'иння', 'іння', 'ості', 'ість'
  ];
  
  const filtered = sorted.filter(word => {
    // Видаляємо слова з небажаними суфіксами
    if (badSuffixes.some(suffix => word.endsWith(suffix))) {
      return false;
    }
    
    // Видаляємо слова, що складаються з однакових літер
    if (new Set(word.split('')).size <= 2) {
      return false;
    }
    
    return true;
  });

  // 8) Беремо топ-N слів
  const result = filtered.slice(0, topN);

  console.log("Фінальні ключові слова:", result);
  return result;
}


// server/src/services/keywordExtractor.js
// import rake from "rake-js";
// import sw from "stopword";

// const ukrStopwords = [
//   "і","в","не","на","та","що","з","до","у","по","за","як","то","це","для",
//   "при","від","із","до","або","про","над","під","чи","ж","але","який","яка",
//   "які","їх","її","він","вона","вони","було","бути","є","тощо","саме","тому"
// ];

// export function extractKeywords(text = "", topN = 20) {
//   if (!text || typeof text !== "string") return [];

//   // Попередня очистка
//   const cleaned = text
//     .replace(/[.,\/#!$%\^&\*;:{}=\-_`~()«»"“”]/g, " ")
//     .replace(/\s{2,}/g, " ")
//     .toLowerCase();

//   console.log("Текст для витягування ключових слів:", cleaned);

//   // Генерація ключових фраз RAKE
//   const allKeywords = rake(cleaned, { stopWords: ukrStopwords });

//   console.log("rake:", rake);

//   console.log("Всі витягнуті ключові слова/фрази:", allKeywords);

//   // Повертаємо тільки слова/фрази
//   const topKeywords = allKeywords
//     .slice(0, topN)
//     .map(k => k[0].trim()) // k[0] — сама фраза
//     .filter(Boolean);

//   console.log("Топ витягнуті ключові слова/фрази:", topKeywords);

//   return topKeywords;
// }
